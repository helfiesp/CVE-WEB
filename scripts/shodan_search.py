from shodan import Shodan
import sqlite3
import datetime
import sqliteconnect as SQLC
from misc_scripts import secrets
import os
from deepdiff import DeepDiff
import json

api = Shodan(os.environ["SHODAN_API_SECRET"])



def KatrtoteketCheck(ip, port):
    header = {"key": os.environ["KARTOTEKET_NETWORK_API_SECRET"]}
    base_query = 'https://kartoteket.oslo.kommune.no/ukecsirt/ipsok/api/?ip={}&port={}'.format(ip,port)
    result = requests.get(base_query, headers=header).json()
    print(result)


def SQLiteShodanCheckIPChanges(conn):
    cur = conn.cursor()
    cur.execute("SELECT scan_data from alerts_shodanresults")
    result = cur.fetchall()
    conn.close()
    existing_entry_ips = []
    count = 0
    for entry in result:
        existing_entry_ips.append(eval(entry[0])["ip_str"])
    return existing_entry_ips

def SQLiteShodanDataInsert(conn, data):
    sql = "INSERT INTO alerts_shodanresults(scan_data,entry_ip,entry_port,scan_time)VALUES(?,?,?,?)"
    values = (str(data),data["ip_str"], data["port"], datetime.date.today())
    cur = conn.cursor()
    cur.execute(sql,values)
    conn.commit()
    conn.close()
    print("DATA INSERTED: {}".format(data["ip_str"]))

def SQLiteShodanStatsInsert(conn, changes):
    if len(changes) == 0:
        changes = None
    sql = "INSERT INTO alerts_shodanscans(scan_time,changes_since_last)VALUES(?,?)"
    values = (datetime.date.today(),str(changes))
    cur = conn.cursor()
    cur.execute(sql,values)
    conn.commit()
    conn.close()
    

def SQLiteShodanCheckEntry(conn, data):
    cur = conn.cursor()
    cur.execute("SELECT scan_data,id from alerts_shodanresults where entry_ip=? and entry_port=?",(data["ip_str"], data["port"]))
    result = cur.fetchall()
    conn.close()
    if result:
        return result[0]
    else:
        return False

def SQLiteShodanUpdateEntry(conn, data, existing_entry):
    existing_entry_id = existing_entry[1]
    existing_entry_data = eval(existing_entry[0])
    differences = DeepDiff(existing_entry_data, data)
    sql = "UPDATE alerts_shodanresults SET scan_data=?,last_updated=?,changes_since_update=? WHERE id=?"
    values = (str(data),datetime.date.today(),str(differences),existing_entry_id)
    cur = conn.cursor()
    cur.execute(sql,values)
    conn.commit()
    conn.close()


def main():
    search = 'net:171.23.0.0/16'
    results = api.search(search)
    results2 = api.search(search, page=2)
    results3 = api.search(search, page=3)
    result_amount = results["total"]
    values = [results, results2, results3]
    existing_entry_ips = SQLiteShodanCheckIPChanges(SQLC.SQLiteConnect())
    new_ips = []
    for index in range(len(values)):
        entries = values[index]["matches"]
        for entry in entries:
            existing_entry = SQLiteShodanCheckEntry(SQLC.SQLiteConnect(), entry)
            if existing_entry:
                SQLiteShodanUpdateEntry(SQLC.SQLiteConnect(),entry,existing_entry)
            else:
                SQLiteShodanDataInsert(SQLC.SQLiteConnect(), entry)
                new_entry_data = {'ip':entry["ip_str"],'port':entry["port"]}
                new_ips.append(new_entry_data.copy())
    SQLiteShodanStatsInsert(SQLC.SQLiteConnect(), new_ips)


if __name__ == '__main__':
    try:
        #main()
        KatrtoteketCheck("171.23.4.40", "443")
    except Exception as e:
        print("Error with Shodan search: {}".format(e))