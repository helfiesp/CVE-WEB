from shodan import Shodan
import sqlite3
from datetime import datetime
import sqliteconnect as SQLC
from scripts.misc_scripts import secrets
import os

api = Shodan(os.environ["SHODAN_API_SECRET"])

now = datetime.now()
date = now.strftime("%m/%d/%Y %H:%M:%S")


def SQLiteShodanDataInsert(conn, data):
	sql = "INSERT INTO alerts_shodanresults(scan_data,scan_time)VALUES(?,?)"
	values = (data,date)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()

def ShodanSearchInsert(conn):
	sql = "INSERT INTO alerts_shodanscans(scan_time)VALUES(?)"
	values = (date,)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()
	
def main():
	count = 0
	search = 'net:171.23.0.0/16'
	results = api.search(search)
	results2 = api.search(search, page=2)
	results3 = api.search(search, page=3)
	result_amount = results["total"]
	values = [results,results2,results3]
	for index in range(len(values)):
		for key in values[index]:
			try:
				for x in values[index][key]:
					SQLiteShodanDataInsert(SQLC.SQLiteConnect(),str(x))
			except TypeError:
				pass
	ShodanSearchInsert(SQLC.SQLiteConnect())

if __name__ == '__main__':
	main()