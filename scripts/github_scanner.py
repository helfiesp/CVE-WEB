import datetime
import time
from github import Github
import base64

def GetCurrentTime():
	now = datetime.datetime.now()
	current_time = now.strftime("%H:%M:%S")
	return current_time


# Create a Github object without authentication
g = Github()

# Specify the Github organization whose repositories will be searched
org = g.get_organization("oslokommune")

# Specify the keyword to search for
keyword = "password"

# Create an empty dictionary to store the search results
results = {}

# Loop through each repository owned by the organization
for repo in org.get_repos():

    # Check if the repository is public
    if not repo.private:
    
        # Loop through each file in the repository
        contents = repo.get_contents("")
        while contents:
            file_content = contents.pop(0)
            if file_content.type == "dir":
                contents.extend(repo.get_contents(file_content.path))
            else:
                # Check if the file is encoded in base64 format
                if file_content.encoding == "base64":
                    # Decode the file content and split it into lines
                    lines = base64.b64decode(file_content.content).decode('utf-8').splitlines()
                else:
                    # If the file is not encoded in base64 format, read it as text
                    lines = file_content.decoded_content.decode('utf-8').splitlines()
            
                # Loop through each line in the file
                for i, line in enumerate(lines):
                
                    # Check if the line contains the keyword
                    if keyword in line:
                    
                        # If the keyword is found, create a dictionary entry for the result
                        result = {"keyword": keyword, "repository": repo.name, "file": file_content.path, "line": i+1}
                        
                        # Add the entire sentence containing the keyword to the dictionary entry
                        sentence_start = max(0, i-1)
                        sentence_end = min(len(lines), i+2)
                        sentence = " ".join(lines[sentence_start:sentence_end])
                        result["sentence"] = sentence
                        
                        # Add the result to the dictionary of results
                        results.setdefault(repo.name, []).append(result)

# Print the search results
print(results)
