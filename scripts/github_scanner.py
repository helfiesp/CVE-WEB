import datetime
import time
from github import Github
import base64
from misc_scripts import secrets
import os

def GetCurrentTime():
	now = datetime.datetime.now()
	current_time = now.strftime("%H:%M:%S")
	return current_time

g = Github(os.environ["GITHUB_API_SECRET_BASIC"])

# set up search parameters
search_query = "password"
extension_blacklist = [".jpg", ".png", ".pdf", ".zip", ".md", ".woff"]
word_blacklist = ["README"]
results = []

# search the user's repositories
user = g.get_user("oslokommune")
for repo in user.get_repos():
    for file in repo.get_contents(""):
        if file.path.endswith(tuple(extension_blacklist)):
            continue  # skip non-text files
        if file.path in word_blacklist:
            continue
        try:
            if file.encoding == "base64" and search_query in file.decoded_content.decode('utf-8'):
                # store search result in dictionary
                result = {
                    "keyword": search_query,
                    "repository_name": repo.name,
                    "file_path": file.path,
                    "line_number": file.decoded_content.decode('utf-8').index(search_query) + 1,
                    "full_path": f"https://github.com/{repo.full_name}/blob/{repo.default_branch}/{file.path}#L{i+1}"
                }
                results.append(result)
        except Exception as e:
            print(f"Error decoding file {file.path}: {e}")

# print search results
for result in results:
    print(result)

