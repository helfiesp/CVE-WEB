import datetime
import time
from github import Github
import base64
from misc_scripts import secrets
import os

def GetCurrentTime():
	now = datetime.datetime.now()
	current_time = now.strftime("%H:%M:%S")
	return current_time

g = Github(os.environ["GITHUB_API_SECRET_BASIC"])

# set up search parameters
search_query = "password"
extension_blacklist = [".jpg", ".png", ".pdf", ".zip", ".md", ".woff"]
word_blacklist = ["README", "LICENSE", "Makefile", "makefile"]
results = []

# search the user's repositories
user = g.get_user("oslokommune")
for repo in user.get_repos():
    #print("[{}] Checking repo: {}".format(GetCurrentTime(), repo.full_name))
    for file in repo.get_contents(""):
        if file.path.endswith(tuple(extension_blacklist)):
            continue  # skip non-text files
        if file.path in word_blacklist:
            continue
        try:
            if file.encoding == "base64":
                content = file.decoded_content.decode('utf-8')
                if search_query.lower() in content.lower():
                    # extract the sentence containing the keyword
                    lines = content.split("\n")
                    for i, line in enumerate(lines):
                        if search_query in line:
                            sentence = line.strip()
                            break
                    else:
                        sentence = ""

                    # store search result in dictionary
                    result = {
                        "keyword": search_query,
                        "repository_name": repo.name,
                        "file_path": file.path,
                        "full_path": f"https://github.com/{repo.full_name}/blob/{repo.default_branch}/{file.path}",
                        "sentence": sentence
                    }
                    results.append(result)
            else:
                print(file.path)
        except Exception as e:
            print(f"Error decoding file {file.path}: {e}")

# print search results
for result in results:
    print(result)