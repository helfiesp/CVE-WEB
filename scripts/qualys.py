import sqliteconnect as SQLC
from misc_scripts import secrets
from datetime import date, timedelta, datetime
import pandas as pd
import json
import sqlite3
import requests
import time
import os


def LoadProxy():
    os.environ["http_proxy"] = "http://{}:{}@inetproxy.oslofelles.oslo.kommune.no:3128".format(os.environ["CSIRT_LDAPUSER"], os.environ["CSIRT_LDAPPASSWORD"])
    os.environ["https_proxy"] = "http://{}:{}@inetproxy.oslofelles.oslo.kommune.no:3128".format(os.environ["CSIRT_LDAPUSER"], os.environ["CSIRT_LDAPPASSWORD"])

def DisableProxy():
    os.environ.pop("http_proxy", None)
    os.environ.pop("https_proxy", None)

def GetCurrentTime():
    return datetime.now().strftime("%H:%M:%S")

def main():
    start_time = time.time()  # Starting the timer

    cisa_vulns = GetCisaVulns()
    filename = "/var/csirt/source/CVE-WEB/uploads/qualys_vulns/QualysVulnerabilities.xlsx"
    new_data = pd.read_excel(filename).to_dict('records')
    current_data_tuples = get_current_data(SQLC.SQLiteConnect())

    print(f"Number of new data entries to compare: {len(new_data)}")

    inserted_entries = 0  # Counter for new entries inserted
    updated_entries = 0   # Counter for entries updated

    insert_list = []
    update_list = []

    if new_data:
        for entry in new_data:
            if "nan" not in str(entry["Hostname"]):
                current_entry_tuple = (str(entry["ID"]), str(entry["Hostname"]).strip())

                if current_entry_tuple not in current_data_tuples:
                    #InsertQualysData(SQLC.SQLiteConnect(), entry, cisa_vulns)
                    insert_list.append(entry)
                    inserted_entries += 1
                else:
                    #update_data(SQLC.SQLiteConnect(), entry, cisa_vulns)
                    update_list.append(entry)
                    updated_entries += 1
    else:
        print("[{}] No new Qualys data available...".format(GetCurrentTime()))

    if insert_list:
        with SQLC.SQLiteConnect() as conn:
            transformed_insert_list = transform_insert_data(insert_list, cisa_vulns)
            batch_insert_data(conn, transformed_insert_list)

    if update_list:
        with SQLC.SQLiteConnect() as conn:
            batch_update_data(conn, transform_update_data(update_list, cisa_vulns))

    elapsed_time = time.time() - start_time  # Calculating the time taken

    # Printing the summary
    print("\nSummary:")
    print(f"Total time taken: {elapsed_time:.2f} seconds")
    print(f"Total entries updated: {updated_entries}")
    print(f"Total entries added: {inserted_entries}")


def get_current_data(conn):
    cur = conn.cursor()
    cur.execute("SELECT qualys_id, hostname FROM alerts_qualysresults")
    results = cur.fetchall()
    data_set = {(str(qualys_id), str(hostname).strip()) for qualys_id, hostname in results}
    conn.close()
    return data_set


def batch_insert_data(conn, insert_list):
    sql = """INSERT INTO alerts_qualysresults(
                 qualys_id, severity, status, hostname, ip, title, first_detected,
                 last_detected, last_fixed, internet_exposed, filepath, cve, os, scan_time,
                 known_exploited, known_exploited_cves)
                 VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"""

    cur = conn.cursor()
    cur.executemany(sql, insert_list)
    conn.commit()

    
def batch_update_data(conn, update_list):
    cur = conn.cursor()
    sql = """UPDATE alerts_qualysresults SET
                severity=?, status=?, title=?, first_detected=?, 
                last_detected=?, last_fixed=?, filepath=?, 
                cve=?, scan_time=?, known_exploited=?, known_exploited_cves=? 
             WHERE qualys_id=?"""
    cur.executemany(sql, update_list)
    conn.commit()

def transform_insert_data(insert_list, cisa_vulns):
    transformed_data = []
    for data in insert_list:
        known_exploited = CheckKnownExploited(cisa_vulns, data["CVE ID"])
        known_exploited_check = 1 if known_exploited else 0
        known_exploited_cves = ','.join(known_exploited) if known_exploited else ''

        transformed_entry = (
            data["ID"], data["Severity"], data["Status"], data["Hostname"], data["IP"],
            data["Title"], str(data["First detected"]), str(data["Last detected"]),
            str(data["Date Last Fixed"]), str(data["Public Facing"]), data["Results"],
            str(data["CVE ID"]), data["OS"], date.today() - timedelta(days=1),
            known_exploited_check, known_exploited_cves
        )
        transformed_data.append(transformed_entry)

    return transformed_data



def transform_update_data(update_list, cisa_vulns):
    transformed_data = []
    for entry in update_list:
        known_exploited = CheckKnownExploited(cisa_vulns, entry["CVE ID"])
        known_exploited_check = 1 if known_exploited else 0
        data_tuple = (entry["Severity"], entry["Status"], entry["Title"], 
                      str(entry["First detected"]), str(entry["Last detected"]),
                      str(entry["Date Last Fixed"]), entry["Results"],
                      str(entry["CVE ID"]), date.today() - timedelta(days=1), 
                      known_exploited_check, str(known_exploited), entry["ID"])
        transformed_data.append(data_tuple)
    return transformed_data


def update_data(conn, data, cisa_vulns):
    #print("Updating entry: {} | Status: {}".format(data["Hostname"], data["Status"]))
    known_exploited = CheckKnownExploited(cisa_vulns, data["CVE ID"])
    if known_exploited:
        known_exploited_check = 1
    else:
        known_exploited_check = 0

    cur = conn.cursor()
    sql = """UPDATE alerts_qualysresults SET
                severity=?, status=?, title=?, first_detected=?, 
                last_detected=?, last_fixed=?, filepath=?, 
                cve=?, scan_time=?, known_exploited=?, known_exploited_cves=? 
             WHERE qualys_id=?"""
    values = (data["Severity"], data["Status"],
              data["Title"], str(data["First detected"]), str(data["Last detected"]),
              str(data["Date Last Fixed"]),data["Results"],
              str(data["CVE ID"]),date.today() - timedelta(days=1), 
              known_exploited_check, str(known_exploited), data["ID"])
    try:
        cur.execute(sql, values)
    except sqlite3.IntegrityError as e:
        print("[{}] ERROR: Qualys data update failed with error: {} and values: {}".format(GetCurrentTime(), e, values))
    conn.commit()
    conn.close()

def delete_entry(conn, db_id):
    cur = conn.cursor()
    cur.execute("DELETE FROM alerts_qualysresults WHERE qualys_id=?", (db_id,))
    conn.commit()
    conn.close()


def GetCisaVulns():
    cve_list = []
    LoadProxy()
    cisa_url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    cisa_data = requests.get(cisa_url).json()
    for entry in cisa_data["vulnerabilities"]:
        if entry["cveID"] not in cve_list:
            cve_list.append(entry["cveID"])
    DisableProxy()
    return cve_list

def CheckKnownExploited(cisa_vulns, cves):
    # Checks if a vulnerability is known exploited
    known_exploited = []

    # Ensure cves is a string before attempting to split
    if not isinstance(cves, str):
        return known_exploited

    cves_splitted = cves.split(",")

    for cve in cves_splitted:
        if cve in cisa_vulns:
            known_exploited.append(cve)

    return known_exploited
    
def InsertQualysData(conn, data, cisa_vulns):
    if data["ID"] != "nan":
        try:
            known_exploited = CheckKnownExploited(cisa_vulns, data["CVE ID"])
            if known_exploited:
                known_exploited_check = 1
            else:
                known_exploited_check = 0
        except:
            known_exploited = []
            known_exploited_check = 0

        # Check if the entry already exists in the database
        check_sql = "SELECT * FROM alerts_qualysresults WHERE qualys_id=? AND hostname=?"
        cur = conn.cursor()
        cur.execute(check_sql, (data["ID"], data["Hostname"]))
        existing_entry = cur.fetchone()

        if existing_entry:
            print(f"Entry with qualys_id: {data['ID']} and hostname: {data['Hostname']} already exists. Skipping insertion.")
            return

        sql = """INSERT INTO alerts_qualysresults(
                 qualys_id,severity,status,hostname,ip,title,first_detected,
                 last_detected,last_fixed,internet_exposed,filepath,cve,os,scan_time,known_exploited, known_exploited_cves)
                 VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"""
        values = (data["ID"], data["Severity"], data["Status"], data["Hostname"], data["IP"],
                  data["Title"], str(data["First detected"]), str(data["Last detected"]),
                  str(data["Date Last Fixed"]), str(data["Public Facing"]), data["Results"],
                  str(data["CVE ID"]), data["OS"], date.today() - timedelta(days=1), known_exploited_check, ','.join(known_exploited))
        try:
            cur.execute(sql, values)
            conn.commit()
        except sqlite3.IntegrityError:
            if "nan" not in str(values):
                print("[{}] ERROR: Qualys data upload failed with values: {}".format(GetCurrentTime(), values))
        finally:
            conn.close()

if __name__ == '__main__':
    print("[{}] Qualys data upload started...".format(GetCurrentTime()))
    main()
    print("[{}] Qualys data upload finished...".format(GetCurrentTime()))