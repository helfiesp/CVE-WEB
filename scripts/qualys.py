import os
import sqliteconnect as SQLC
from misc_scripts import secrets
import datetime

filename = input("Please enter path and filename: ")

def FilterQualysData():
	with open(filename) as f:
		lines = [line.rstrip('\n') for line in f]
	full_str = ""
	for line in lines:
		line = line.strip()
		if "ID;Severity;Status;Hostname;IP;Title;First detected;Last detected;Date Last Fixed;Public Facing;Results;CVE ID;OS" not in line:
			if len(line) > 5:
				if line[0].isnumeric() and line.count(";") > 5:
					full_str += "_-/*{}".format(line)
				else:
					full_str += line

	list_of_vulns = full_str.split("_-/*")
	return list_of_vulns

def AddQualysData(vulns):
	lengths = []
	for dataset in vulns:
		dataset = dataset.split(";")
		if len(dataset) > 1:
			InsertQualysData(SQLC.SQLiteConnect(), dataset)

def InsertQualysData(conn, data):
	try:
		sql = """INSERT INTO alerts_qualysresults(severity,status,hostname,ip,title,first_detected,last_detected,last_fixed,internet_exposed,filepath,cve,os,scan_time)
				 VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?)"""
		values = (data[1], data[2], data[3], data[4], data[5], data[6], data[7], data[8], data[9],data[10],data[11],data[12],datetime.date.today())
		cur = conn.cursor()
		cur.execute(sql,values)
		conn.commit()
		conn.close()
	except Exception as e:
		print(data)
		
if __name__ == '__main__':
	AddQualysData(FilterQualysData())