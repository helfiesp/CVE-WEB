import sqliteconnect as SQLC
from misc_scripts import secrets
import datetime
import pandas as pd

def main():
	filename = "/var/csirt/Vulnerabilities.xlsx"
	data = pd.read_excel(filename).to_dict('records')
	if data:
		DeleteCurrentData(SQLC.SQLiteConnect())
	for entry in data:
		InsertQualysData(SQLC.SQLiteConnect(), entry)

def DeleteCurrentData(conn):
	cur = conn.cursor()
	cur.execute("DELETE FROM alerts_qualysresults")
	conn.commit()
	conn.close()

def InsertQualysData(conn, data):
	sql = """INSERT INTO alerts_qualysresults(
	         severity,status,hostname,ip,title,first_detected,
	         last_detected,last_fixed,internet_exposed,filepath,cve,os,scan_time,known_exploited)
			 VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?)"""
	values = (data["Severity"], data["Status"], data["Hostname"], data["IP"],
		      data["Title"], str(data["First detected"]), str(data["Last detected"]),
		      str(data["Date Last Fixed"]), str(data["Public Facing"]),data["Results"],
		      str(data["CVE ID"]),data["OS"],datetime.date.today(), 0)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()

if __name__ == '__main__':
	main()