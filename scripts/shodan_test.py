
import sqlite3
from datetime import datetime
import time
import scripts.shodan_filter as shodan_filter

now = datetime.now()
date = now.strftime("%m/%d/%Y %H:%M:%S")

def SQLiteConnect():
	conn = None
	try:
		conn = sqlite3.connect("/var/csirt/source/csirt_alerts/db.sqlite3")
	except Error as e:
		print(e)
	return conn

def SQLiteShodanDataInsert(conn, data):
	sql = "INSERT INTO alerts_shodanresults(scan_data,scan_time)VALUES(?,?)"
	date = now.strftime("%m/%d/%Y %H:%M:%S")
	values = (data,date)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()

def SQLiteShodanGetData(conn):
    cur = conn.cursor()
    cur.execute("SELECT * from alerts_shodanresults")
    result = cur.fetchall()
    conn.close()
    if result:
    	return result
    else:
        return False

def SQLiteShodanGetTime(conn):
    cur = conn.cursor()
    cur.execute("SELECT scan_time from alerts_shodanresults ORDER BY scan_time LIMIT 1")
    result = str(cur.fetchone()).replace("(","").replace(")","").replace("'","").replace(",","")
    conn.close()
    if result:
    	return result
    else:
        return False


def GetResults():
	results = SQLiteShodanGetData(SQLiteConnect())
	differences = shodan_filter.CompareDifferences(results)
	results_list = []
	for x in results:
		if str(x[-1]).split()[0] == str(date).split()[0]:
			entry = eval(x[1])
			entry["domains"] = str(entry["domains"]).replace('[','').replace(']','').replace("'","")
			entry["timestamp"] = str(entry["timestamp"]).split("T")[0]
			results_list.append(entry)
	resultset = [results_list, differences]
	return resultset

