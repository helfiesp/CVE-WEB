
import sqlite3
from datetime import datetime
import time
import scripts.shodan_filter as shodan_filter
import scripts.sqliteconnect as SQLC

now = datetime.now()
date = now.strftime("%m/%d/%Y %H:%M:%S")

def SQLiteShodanDataInsert(conn, data):
	sql = "INSERT INTO alerts_shodanresults(scan_data,scan_time)VALUES(?,?)"
	date = now.strftime("%m/%d/%Y %H:%M:%S")
	values = (data,date)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()

def SQLiteShodanGetData(conn):
    cur = conn.cursor()
    cur.execute("SELECT * from alerts_shodanresults")
    result = cur.fetchall()
    conn.close()
    if result:
    	return result
    else:
        return False

def SQLiteShodanGetTime(conn):
    cur = conn.cursor()
    cur.execute("SELECT scan_time from alerts_shodanresults ORDER BY scan_time LIMIT 1")
    result = str(cur.fetchone()).replace("(","").replace(")","").replace("'","").replace(",","")
    conn.close()
    if result:
    	return result
    else:
        return False


def GetResults():
	results = SQLiteShodanGetData(SQLC.SQLiteConnect())
	differences = "N/A"
	results_list = []
	for x in results:
		entry = eval(x[1])
		entry["domains"] = str(entry["domains"]).replace("[","").replace("]","").replace("'","")
		entry["timestamp"] = entry["timestamp"].split("T")[0]
		if "product" not in entry:
			entry["product"] = "N/A"
		if entry not in results_list:
			results_list.append(entry)
		date_added = x[2]
		comments = x[3]
		resultset = {"entry":entry,"date_added":date_added, "comments":comments}
		results_list.append(resultset.copy())
	return results_list

