from misc_scripts import secrets
import os
import json
import requests
import base64
from datetime import datetime
import sqlite3
import sqliteconnect as SQLC


now = datetime.now()
date = now.strftime("%m/%d/%Y %H:%M:%S")

def SQLiteVirustotalInsertURLData(conn, data):
	sql = "INSERT INTO alerts_virustotalurlscan(scan_data,scan_time)VALUES(?,?)"
	values = (data,date)
	cur = conn.cursor()
	cur.execute(sql,values)
	conn.commit()
	conn.close()

def CheckURL(url):
	data = []
	url_id = base64.urlsafe_b64encode(url.encode()).decode().strip("=")
	base_query = 'https://www.virustotal.com/api/v3/urls/{}'.format(url_id)
	header = {"x-apikey": os.environ["VIRUSTOTAL_API_SECRET"]}
	result = str(requests.get(base_query, headers=header).json()["data"])
	SQLiteVirustotalInsertURLData(SQLC.SQLiteConnect(),result)

CheckURL("oslo.kommune.no")