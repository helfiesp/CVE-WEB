
from misc_scripts import secrets


def LDAPSearch(lpath, lfilter, lproperties, ltimeout, ):
	import ldap, os
	server = 'ldaps://ldaps.oslofelles.oslo.kommune.no:636'
	user = os.environ["CSIRT_LDAPUSER"]
	password = os.environ["CSIRT_LDAPPASSWORD"]

	ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_NEVER)
	ldap.set_option(ldap.OPT_PROTOCOL_VERSION, 3)
	ldapClient = ldap.initialize(server)
	ldapClient.timeout = ltimeout
	ldapClient.set_option(ldap.OPT_REFERRALS, 0)
	ldapClient.bind_s(user, password)
	return ldapClient.search_s(lpath, ldap.SCOPE_SUBTREE, lfilter, lproperties)
	



def LDAPGetUserInfo(username):
	ldap_properties = ['cn', 'mail', 'givenName', 'displayName', 'sn', 'userAccountControl', 'logonCount', 'memberOf', 'lastLogonTimestamp', 'title', 'description', 'otherMobile', 'mobile', 'objectClass']
	ldap_filter = ('(&(objectClass=user)(cn=%s))' % username)
	ldap_path = "DC=oslofelles,DC=oslo,DC=kommune,DC=no"
	results = LDAPSearch(ldap_path, ldap_filter, ldap_properties, 10)
	print(results)


def LDAPGetUsers():
	import ldap, os
	ldap_server = 'ldaps://ldaps.oslofelles.oslo.kommune.no:636'
	ldap_base_dn  = "DC=oslofelles,DC=oslo,DC=kommune,DC=no"
	ldap_username = os.environ["CSIRT_LDAPUSER"]
	ldap_password = os.environ["CSIRT_LDAPPASSWORD"]

	ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_NEVER)
	ldap.set_option(ldap.OPT_PROTOCOL_VERSION, 3)
	ldap_conn = ldap.initialize(ldap_server)
	ldap_conn.set_option(ldap.OPT_REFERRALS, 0)
	ldap_conn.bind_s(ldap_username, ldap_password)

	page_size = 1000
	cookie = b""
	users = []
	while True:
	    user_filter = "(objectClass=user)"
	    user_attributes = ["sAMAccountName", "givenName", "sn", "mail"]
	    search_results = ldap_conn.search_ext_s(
	        ldap_base_dn,
	        ldap.SCOPE_SUBTREE,
	        user_filter,
	        user_attributes,
	        serverctrls=[ldap.controls.SimplePagedResultsControl(size=page_size, cookie=cookie)],
	    )
	    if search_results:
	        result = search_results[0][1]
	        server_controls = search_results[0][2]
	        users.extend(result)
	        for control in server_controls:
	            if isinstance(control, ldap.controls.SimplePagedResultsControl):
	                cookie = control.cookie
	                break
	        else:
	            break
	    else:
	        break

	# Print the results
	for user in users:
	    print(
	        user["sAMAccountName"][0].decode(),
	        user["givenName"][0].decode(),
	        user["sn"][0].decode(),
	        user["mail"][0].decode(),
	    )

	# Unbind from LDAP server
	ldap_conn.unbind()


LDAPGetUsers()