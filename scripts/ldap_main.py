
from misc_scripts import secrets


def LDAPSearch(lpath, lfilter, lproperties, ltimeout, ):
	import ldap, os
	server = 'ldaps://ldaps.oslofelles.oslo.kommune.no:636'
	user = os.environ["CSIRT_LDAPUSER"]
	password = os.environ["CSIRT_LDAPPASSWORD"]

	ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_NEVER)
	ldap.set_option(ldap.OPT_PROTOCOL_VERSION, 3)
	ldapClient = ldap.initialize(server)
	ldapClient.timeout = ltimeout
	ldapClient.set_option(ldap.OPT_REFERRALS, 0)
	ldapClient.bind_s(user, password)
	return ldapClient.search_s(lpath, ldap.SCOPE_SUBTREE, lfilter, lproperties)
	



def LDAPGetUserInfo(username):
	ldap_properties = ['cn', 'mail', 'givenName', 'displayName', 'sn', 'userAccountControl', 'logonCount', 'memberOf', 'lastLogonTimestamp', 'title', 'description', 'otherMobile', 'mobile', 'objectClass']
	ldap_filter = ('(&(objectClass=user)(cn=%s))' % username)
	ldap_path = "DC=oslofelles,DC=oslo,DC=kommune,DC=no"
	results = LDAPSearch(ldap_path, ldap_filter, ldap_properties, 10)
	print(results)


def LDAPGetUsers():
	import ldap, os
	LDAP_SERVER = 'ldaps://ldaps.oslofelles.oslo.kommune.no:636'
	LDAP_USERNAME  = os.environ["CSIRT_LDAPUSER"]
	LDAP_PASSWORD  = os.environ["CSIRT_LDAPPASSWORD"]

	ldap.set_option(ldap.OPT_X_TLS_REQUIRE_CERT, ldap.OPT_X_TLS_NEVER)
	ldap.set_option(ldap.OPT_PROTOCOL_VERSION, 3)
	ldap_conn = ldap.initialize(ldap_server)
	ldap_conn.set_option(ldap.OPT_REFERRALS, 0)
	ldap_conn.bind_s(ldap_username, ldap_password)

	ldap_base = "DC=oslofelles,DC=oslo,DC=kommune,DC=no"
	ldap_filter = "(objectClass=user)"
	ldap_attributes = ["cn", "displayName"]

	page_control = ldap.controls.SimplePagedResultsControl(True, size=1000, cookie="")

	while True:
		search_results = ldap_connection.search_ext(
			ldap_base,
			ldap.SCOPE_SUBTREE,
			ldap_filter,
			ldap_attributes,
			serverctrls=[page_control]
		)
		_, _, _, server_controls = ldap_connection.result3(search_results)
		users = []
		for dn, user in search_results[0]:
			users.append({
				"cn": user.get("cn", [None])[0],
				"displayName": user.get("displayName", [None])[0]
			})
		cookie = server_controls[0].cookie
		if not cookie:
			break
		page_control.cookie = cookie

	ldap_connection.unbind_s()
	return users

if __name__ == "__main__":
	users = LDAPGetUsers()
	for user in users:
		print(user["cn"], user["displayName"])
