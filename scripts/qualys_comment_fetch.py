import sqliteconnect as SQLC
from misc_scripts import secrets
from datetime import date, timedelta, datetime
import pandas as pd
import json
import sqlite3
import requests
import time
import os

def get_current_data(conn):
    # Initialize the cursor
    cur = conn.cursor()

    # Execute the query to fetch data
    cur.execute("SELECT qualys_id, hostname FROM alerts_qualysresults")
    results = cur.fetchall()
    
    # Total number of records
    total_records = len(results)
    print(f"Total records to process: {total_records}")

    # Iterate through each result
    for i, result in enumerate(results, 1):
        qualys_id, hostname = result

        # Create the qualys_identifier tuple
        qualys_identifier = (hostname, qualys_id)

        # Print the current iteration, hostname, and qualys_id
        print(f"Processing record {i}/{total_records}: Hostname - {hostname}, Qualys ID - {qualys_id}")

        # Insert or update the qualys_identifier in the database
        update_query = """
		UPDATE alerts_qualysresults 
		SET qualys_identifier = ? 
		WHERE qualys_id = ? AND hostname = ?
		"""
		cur.execute(update_query, (str(qualys_identifier), qualys_id, hostname))


    # Commit the transaction
    conn.commit()

    # Close the connection
    conn.close()
    print("All records have been processed.")


def main():
	get_current_data(SQLC.SQLiteConnect())


main()