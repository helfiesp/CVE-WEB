import sqlite3
from datetime import datetime
from misc_scripts import secrets
import requests
import os
import json
import csv

db_path = "/var/csirt/source/CVE-WEB/db.sqlite3"
api_key = os.environ["HAVEIBEENPWNED_API_KEY"]

headers = {
    "hibp-api-key": api_key,
    "Content-Type": "application/json"
}


def LoadProxy():
    os.environ["http_proxy"] = "http://{}:{}@inetproxy.oslofelles.oslo.kommune.no:3128".format(os.environ["CSIRT_LDAPUSER"], os.environ["CSIRT_LDAPPASSWORD"])
    os.environ["https_proxy"] = "http://{}:{}@inetproxy.oslofelles.oslo.kommune.no:3128".format(os.environ["CSIRT_LDAPUSER"], os.environ["CSIRT_LDAPPASSWORD"])

def DisableProxy():
    os.environ.pop("http_proxy", None)
    os.environ.pop("https_proxy", None)


def convert_csv_to_json(csv_data):
    json_data = []
    csv_reader = csv.DictReader(csv_data.splitlines())
    for row in csv_reader:
        json_data.append(row)
    return json_data

def FetchBreachedDomains():
    LoadProxy()
    domains_list = "/var/csirt/source/CVE-WEB/static/hibp_domains.txt"
    with open(domains_list) as file:
        domains = [line.rstrip() for line in file]
    for domain in domains:
        api_endpoint = "https://haveibeenpwned.com/api/v3/breacheddomain/{}".format(domain)
        response = requests.get(api_endpoint, headers=headers, verify=False)

        if response.status_code == 200:
            breaches_data = response.json()
            # Connect to SQLite database
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            for user in breaches_data.keys():
                cursor.execute('''
                INSERT INTO alerts_haveibeenpwnedbreachedaccounts (email_address, breached_sites)
                VALUES (?, ?)
                ''', ("{}@{}".format(user, domain), str(breaches_data[user])))
            conn.commit()
            conn.close()
        else:
            print(f"Failed to fetch data: {response.status_code}")

    DisableProxy()

def FetchBreachInfo():
    LoadProxy()
    api_endpoint = "https://haveibeenpwned.com/api/v3/breaches"
    response = requests.get(api_endpoint, headers=headers, verify=False)
    DisableProxy()

    if response.status_code == 200:
        breaches_data = response.json()

        # Connect to SQLite database
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        # Iterate through each item in the response
        for item in breaches_data:
            # Prepare data for insertion
            name = item.get('Name', '')
            title = item.get('Title', '')
            domain = item.get('Domain', '')
            breach_date = item.get('BreachDate', '')
            added_date = datetime.strptime(item['AddedDate'], '%Y-%m-%dT%H:%M:%SZ') if 'AddedDate' in item else None
            modified_date = datetime.strptime(item['ModifiedDate'], '%Y-%m-%dT%H:%M:%SZ') if 'ModifiedDate' in item else None
            pwn_count = item.get('PwnCount', 0)
            description = item.get('Description', '')
            logo_path = item.get('LogoPath', '')
            data_classes = json.dumps(item.get('DataClasses', []))
            is_verified = item.get('IsVerified', False)
            is_fabricated = item.get('IsFabricated', False)
            is_sensitive = item.get('IsSensitive', False)
            is_retired = item.get('IsRetired', False)
            is_spam_list = item.get('IsSpamList', False)
            is_malware = item.get('IsMalware', False)
            is_subscription_free = item.get('IsSubscriptionFree', False)

            # Insert data into the database
            cursor.execute('''
                INSERT INTO alerts_haveibeenpwnedbreaches (name, title, domain, breach_date, added_date, 
                modified_date, pwn_count, description, logo_path, data_classes, is_verified, 
                is_fabricated, is_sensitive, is_retired, is_spam_list, is_malware, is_subscription_free)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (name, title, domain, breach_date, added_date, modified_date, pwn_count,
                  description, logo_path, data_classes, is_verified, is_fabricated, 
                  is_sensitive, is_retired, is_spam_list, is_malware, is_subscription_free))

        # Commit changes and close the connection
        conn.commit()
        conn.close()
    else:
        print(f"Failed to fetch data: {response.status_code}")

if __name__ == "__main__":
    FetchBreachedDomains()