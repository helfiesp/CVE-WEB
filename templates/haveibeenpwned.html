{% extends "base.html" %}
{% block title %}HaveIBeenPwned{% endblock %}
{% block content %}
{% load custom_tags %}

<div class="CVE_table">
    <h2>HaveIBeenPwned</h2>
    <!-- Add a button for filtering by 'Passwords' data class -->
    <button id="filter-passwords">Show Only 'Passwords' Data Class</button>
    <!-- Add an input for filtering by year -->
    <input type="number" id="filter-year" placeholder="Enter Year" min="1900" max="2099">
    <button id="apply-year-filter">Apply Year Filter</button>

    <table class="sortable" id="data-table">
        <thead>
            <th>Email</th>
            <th>Breached Sites</th>
            <th>Breached Details</th>
        </thead>
        <tbody id="data-rows">
            {% for Entry in breachedaccounts %}
            <tr>
                <td>{{ Entry.email_address }}</td>
                <td>{{ Entry.breached_sites|linkify|safe }}</td>
                <td>
                    {% for breach in Entry.breached_data %}
                        <span class="breach-date"><b>{{ breach.breached_site }}</b>: {{ breach.breach_date }}</span><br>
                        <span class="data-classes">
                            {% for data_class in breach.data_classes %}
                                {{ data_class }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                        <br>
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Function to apply both filters
    function applyFilters() {
        var filterYear = document.getElementById('filter-year').value;
        var rows = document.querySelectorAll('#data-rows tr');
        var showPasswords = document.getElementById('filter-passwords').dataset.showPasswords === 'true'; // Use a data attribute to toggle password filter

        rows.forEach(function(row) {
            var dateText = row.querySelector('.breach-date').innerText;
            var rowYear = dateText.split('-')[0].split(': ')[1]; // Extract the year part of 'Site: YYYY-MM-DD'
            var hasPasswords = row.querySelector('.data-classes').innerText.includes('Passwords');

            // Check both year and password conditions
            var display = true;
            if (filterYear && rowYear !== filterYear) {
                display = false;
            }
            if (showPasswords && !hasPasswords) {
                display = false;
            }
            row.style.display = display ? '' : 'none';
        });
    }

    // Event listener for the 'Show Only "Passwords" Data Class' button
    document.getElementById('filter-passwords').addEventListener('click', function() {
        // Toggle the password filter state
        this.dataset.showPasswords = this.dataset.showPasswords === 'true' ? 'false' : 'true';
        applyFilters();
    });

    // Event listener for the 'Apply Year Filter' button
    document.getElementById('apply-year-filter').addEventListener('click', applyFilters);

    // Initialize the password filter state
    document.getElementById('filter-passwords').dataset.showPasswords = 'false';
</script>
{% endblock %}