{% extends "base.html" %}
{% block title %}CSIRT{% endblock %}
{% block content %}
{% load custom_tags %}
<header>
<script>
    var ctx = document.getElementById('CVEChart').getContext('2d');
    var CVEChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Kritisk', 'Høy', 'Medium', 'Lav', 'N/A'],
            datasets: [{
                label: 'Antall CVEer',
                data: [11, 15, 72, 49, 43],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.5)',  // Kritisk
                    'rgba(255, 193, 7, 0.5)',  // Høy
                    'rgba(40, 167, 69, 0.5)',  // Medium
                    'rgba(0, 123, 255, 0.5)',  // Lav
                    'rgba(23, 162, 184, 0.5)'  // N/A
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(40, 167, 69, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(23, 162, 184, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
</header>

<div class="CVE_table">

<!--
{% if messages %}d
    {% for message in messages %}
        <div id="div_message" class="alert alert-{{ message.tags }}">
        <a class="close" data-dismiss="alert" href="#">×</a>
        <h5 class="alert-heading">{{ message.tags|capfirst }}</h5>
        {{ message }}
        </div>
    {% endfor %}
{% endif %}

-->

{% if user|has_group:'CSIRT' %}
    <p>{{ message|safe }}</p>
    {% if DailyNews %}
    <h2>Varslinger fra andre kilder</h2>
    <p>Denne seksjonen inneholder varslinger fra nyhetskilder som f.eks andre CERTer.</p>
    <div class="News_Alerts">
        <table class="sortable">
            <thead>
                <th>Kilde</th>
                <th>Dato</th>
                <th>Tittel</th>
                <th>Beskrivelse</th>
            </thead>
            {% for article in DailyNews %}
                <tr>
                    <td>{{article.article_source|safe}}</td>
                    <td>{{article.article_date}}</td>
                    <td>{{article.article_title|safe}}</td>
                    <td>{{article.article_description}}</td>
                </tr>
            {% endfor %}
        </table>   
    </div>
    {% endif %}


    {% if TelegramData %}
    <div class="CVE_table">
    <h2>Telegram data</h2>
    <p>Siste dataoppdatering: {{ TelegramData.last_entry }}</p>
    <table class="sortable">
        <thead>
            <th>Kanal</th>
            <th>Nøkkelord</th>
            <th>Melding</th>
            <th>Dato</th>
        </thead>
        {% for Entry in TelegramData.processed_list %}
        <tr>
            <td>{{Entry.channel}}</td>
            <td>{{Entry.highlighted_words|decode_unicode}}</td>
            <td>{{Entry.message_translated}}</td>
            <td>{{Entry.message_date}}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}


    {% if UnlistedCVEs %}
    <div class="CVE_table">
    <h2>Nye CVEer</h2>
    <p>Dette søket kjøres regelmessig, henter resultater fra de siste 2 dagene.<br>
    Søket søker etter CVEer på Google, og sjekker om CVEen ligger i den NVD.<br>
    Hvis den ikke ligger i NVD, er det trolig en ny CVE, som f.eks kan være satt av leverandør i en security advisory.<br>
    Søket scanner igjennom de første 3 sidene med Google resultater.</p>

    <table class="sortable">
        <thead>
            <th>CVE</th>
            <th>Time</th>
            <th>URL</th>
            <th>Header</th>
            <th>Description</th>
        </thead>
        {% for Entry in UnlistedCVEs %}
        <tr>
            <td>{{Entry.cve_id}}</td>
            <td>{{Entry.article_time_since}}</td>
            <td><a href="{{Entry.article_url}}">{{Entry.article_website}}</td>
            <td>{{Entry.article_header}}</td>
            <td>{{Entry.article_description}}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <h2 id="CVE_Header">CVE oversikt: {{ CVEQuery }}</h2>
    <canvas id="CVEChart" width="400" height="200"></canvas>
        <p><b>Antall CVEer: </b> {{ CVECount }}<br>
        {% for key,value in CVEStats.items %}
            <b>{{ key }}</b>: {{ value }} 
        {% endfor %}
        </p>
    <div class="TableFilters">
        <button class="ButtonTableFilters" onclick="location.href='{% url 'index' %}#CVE_Header'">Siste døgn</button>
        <button class="ButtonTableFilters" onclick="location.href='{% url 'cve_weekly' %}#CVE_Header'">Siste 7 dager</button>
        <button class="ButtonTableFilters" onclick="location.href='{% url 'cve_monthly' %}#CVE_Header'">Siste måned</button>
        <button class="ButtonTableFilters" onclick="location.href='{% url 'cve_all' %}#CVE_Header'">Alle</button>
        <form action="send_alert" method="post">
        {% csrf_token %}
        <button class="ButtonTableFilters" type="submit">Send varsling</button>
    </div>
    <hr class="CVE_Table_HR"><br>
    <input type="search" placeholder="Søk..." class="form-control search-input" data-table="cve-list"/>
    <table class="table table-striped mt32 cve-list sortable">
        <thead>
            <tr>
                <th>CVE</th>
                <th>Dato</th>
                <th>Kilde</th>
                <th>CVSS</th>
                <th>OK påvirket</th>
                <!--<th>Tweets</th>-->
                <th>Beskrivelse</th>
                <th>Send varsling</th>
            </tr>
        </thead>
        {% for value in CVE_list  %}

        <tr>
            <td style="width: 50px;"><a href="{{value.cve_url}}" target="_blank">{{value.cve_id}}</a></td>
            <td style="width: 50px;">{{value.date}}</td>
            <td>{{value.source}}</td>
            {% if value.cvss_score != "N/A" %}
                {% if value.cvss_score >= 9 %}
                    <td class="CVSS_Score_Numeric_DarkRed">{{value.cvss_score}}</td>
                {% elif value.cvss_score >= 7.5 and value.cvss_score < 9 %}
                    <td class="CVSS_Score_Numeric_Red">{{value.cvss_score}}</td>
                {% elif value.cvss_score >= 5 and value.cvss_score < 7.5 %}
                    <td class="CVSS_Score_Numeric_Yellow">{{value.cvss_score}}</td>
                {% else %}
                    <td class="CVSS_Score_Numeric_Green">{{value.cvss_score}}</td>
                {% endif %}
            {% else %}
                <td class="CVSS_Score_Numeric_Grey">{{value.cvss_score}}</td>
            {% endif %}
            <td>{{value.potentially_impacted|safe}}</td>
            <!--<td class="CVSS_Score_NA"><a href="https://twitter.com/search?q={{value.cve_id}}&src=typed_query" target="_blank">{{value.recent_tweets}}</td>-->
            
            <td>{{value.description}}</td>
            <td><input class="Alert_Checkbox" type="checkbox" name="send_alert" value="{{value.cve_id}}"></td>
            {% if value.qualys_affected == 1 %}
                <td style="display:none">qualys</td>
            {% endif %}
        </tr>
        {% endfor %}
    </form>
    </table>
</div>

{% endif %}
{% endblock %}