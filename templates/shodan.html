{% load static %}
<html>
<header>
<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
<title>Shodan</title>
<link rel="stylesheet" href="{% static 'css/main_css.css' %}">
<script>
    (function(document) {
        'use strict';

        var TableFilter = (function(myArray) {
            var search_input;

            function _onInputSearch(e) {
                search_input = e.target;
                var tables = document.getElementsByClassName(search_input.getAttribute('data-table'));
                myArray.forEach.call(tables, function(table) {
                    myArray.forEach.call(table.tBodies, function(tbody) {
                        myArray.forEach.call(tbody.rows, function(row) {
                            var text_content = row.textContent.toLowerCase();
                            var search_val = search_input.value.toLowerCase();
                            row.style.display = text_content.indexOf(search_val) > -1 ? '' : 'none';
                        });
                    });
                });
            }

            return {
                init: function() {
                    var inputs = document.getElementsByClassName('search-input');
                    myArray.forEach.call(inputs, function(input) {
                        input.oninput = _onInputSearch;
                    });
                }
            };
        })(Array.prototype);

        document.addEventListener('readystatechange', function() {
            if (document.readyState === 'complete') {
                TableFilter.init();
            }
        });

    })(document);
</script>
</header>

<body>
<div class="Top_Nav">
    <div class="dropdown">
        <button class="Top_Nav_Button" onclick="location.href='{% url 'index' %}'">CVE</button>
    </div>
    <div class="dropdown">
        <button class="Top_Nav_Button" onclick="location.href='{% url 'shodan' %}'">Attack surface</button>
        <div class="dropdown-content">
          <a onclick="location.href='{% url 'shodan' %}'">Shodan</a>
        </div>
    </div>
    <button class="Top_Nav_Button" onclick="location.href='{% url 'qualys' %}'">Qualys</button>

</div>
<div class="CVE_Table_Header">
    <h2>Shodan API</h2>
    <h3>Info om søket</h3>
    <p> <b>Scan time: </b>{{ ShodanScans.ScanTime }}<br>
        {% for key,value in Shodan_Stats.items %}
            <b>{{ key }}</b>: {{ value }}<br>
        {% endfor %}

        <br>
        {% if ShodanScans.IPChanges != "None" %}
            <b>Nye IPer: </b>{{ ShodanScans.IPChanges }}
        {% endif %}
        
    </p>
</div>
<div class="TableFilters">
    <button class="ButtonTableFilters" onclick="location.href='{% url 'shodan' %}'">Alt eksponert</button>
    <button class="ButtonTableFilters" onclick="location.href='{% url 'shodan_vulns_critical_high' %}'">Alvorlige sårbarheter(4,5)</button>
    <button class="ButtonTableFilters" onclick="location.href='{% url 'shodan_vulns_high' %}'">Høye sårbarheter(4)</button>
    <button class="ButtonTableFilters" onclick="location.href='{% url 'shodan_vulns_critical' %}'">Kritiske sårbarheter(5)</button>
    <!-- 
    <form action="update_shodan_entry" method="post">
    {% csrf_token %}
    <button class="ButtonTableFilters" type="submit">Oppdater kommentarer</button> 
    -->
</div> 
<hr class="CVE_Table_HR">
<div class="CVE_Table_Search">
    <input type="search" placeholder="Søk..." class="form-control search-input" data-table="exposed-servers"/>
</div>
<div class="CVE_table">
    <table class="table table-striped mt32 exposed-servers">
    <thead>
        <th>ID</th>
        <th>Product</th>
        <th>IP</th>
        {% if Vulns %}
            <th>Internal data</th>
        {% endif %}
        <th>Port</th>
        <th>HTTP Code</th>
        <th>Last scanned</th>
        {% if Vulns %}
            <th>Vulnerabilities</th>
            <th>CVE</th>
        {% endif %}
        <th>Comments</th>
    </thead>

    {% for Entry in ShodanResults %}
        <tr>
            <td>{{Entry.id}}</td>
            <td>{{Entry.entry_data.product}} {{Entry.entry_data.version}}</td>
            {% if Entry.entry_data.http.status == 200 %}
                {% if Entry.entry_data.port == 80 %}
                    <td><a href="http://{{Entry.entry_data.ip_str}}" target="_blank">{{Entry.entry_data.ip_str}}</a></td>
                {% else %}
                    <td><a href="https://{{Entry.entry_data.ip_str}}" target="_blank">{{Entry.entry_data.ip_str}}</a></td>
                {% endif %}
            {% else %}
                <td><a href="http://{{Entry.entry_data.ip_str}}" target="_blank">{{Entry.entry_data.ip_str}}</a></td>
            {% endif %}

            {% if Vulns %}
            <td>{% for item in Entry.kartoteket_data %}
                    {% for key, value in item.items %}
                        <b>{{ key }}</b>: {{ value }}<br>
                    {% endfor %}
             {% endfor %}</td>  
            {% endif %}
            <td>{{Entry.entry_data.port}}</td>
            {% if Entry.entry_data.http.status == 200 %}
                <td style="color:green">{{Entry.entry_data.http.status}}</td>
            {% elif Entry.entry_data.http.status == 404 %}
                <td style="color:red">{{Entry.entry_data.http.status}}</td>
            {% elif Entry.entry_data.http.status == 301 %}
                <td style="color:blue">{{Entry.entry_data.http.status}}</td>
            {% else %}
                <td>{{Entry.entry_data.http.status}}</td>
            {% endif %}

            <td>{{Entry.entry_data.timestamp}}</td>
            <!-- <td>
            {% for key,value in Entry.entry_data.vulns.items %}
                {% if value.cvss >= 9 %}
                    <div class="CVSS_Critical">
                        <a style="text-decoration: none;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% elif value.cvss >= 7 %}
                    <div class="CVSS_High">
                        <a style="text-decoration: none; text-decoration-color: #f74d40;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% endif %}

            {% endfor %}
            </td> -->
            {% if Vulns %}
            <td>{% for item in Entry.vulnerabilities %}
                    {% if item.severity == 5 %}
                        <div title="{{item.host}}"><div class="CVSS_High"><b>{{ item.vulnerability }}</b><br><br><br></div> </div>
                    {% elif item.severity == 4 %}
                         <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ item.vulnerability }}</b><br><br></div> </div>
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}

             {% if Vulns %}
            <td style="white-space:nowrap;">{% for item in Entry.vulnerabilities %}
                    {% if item.cve %}
                        {% if item.severity == 5 %}
                            {% for x in item.cve %}
                                <div title="{{item.host}}"><div class="CVSS_High"><b>{{ x }}<br></b><br></div> </div>
                            {% endfor %}
                            
                        {% elif item.severity == 4 %}
                            {% for x in item.cve %}
                             <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ x }}<br></b><br></div> </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}
     

     

            <td><textarea rows="2" name="comment">{{Entry.comments}}</textarea></td>
            <td style="display:none"><input type="text" name="entry_id" value="{{Entry.id}}"></td>
            
        </tr>
    {% endfor %}
</form>
</table>

</div>
</div>
</html>

