{% extends "base.html" %}
{% block title %}Shodan{% endblock %}
{% block content %}
{% load custom_tags %}

{% if user|has_group:'CSIRT' %}
<div class="CVE_Table_Header">
    <h2>Angrepsflate</h2>
    <h3>Info om søket</h3>
    <p> <b>Scan time: </b>{{ ShodanScans.ScanTime }}<br>
        {% for key,value in Shodan_Stats.items %}
            <b>{{ key }}</b>: {{ value|replace_comma }}<br>
        {% endfor %}
        {% if ShodanScans.IPChanges != "None" %}
            <br><b>Nye IPer: </b>{{ ShodanScans.IPChanges }}
        {% endif %}
        
    </p>
<hr class="CVE_Table_HR">


<div class="button-container">
    <form action="shodan_search" method="post">
        {% csrf_token %}
        <div class="TableFilters">
            
            <label class="checkbox_container">Webservree<input id="webserver_checkbox" type="checkbox" name="webserver_checkbox" value="1"{% if filters.webservers %} checked="checked"{% endif %}><span class="checkmark"></span></label>
            <label class="checkbox_container">SSH<input id="ssh_checkbox" type="checkbox" name="ssh_checkbox" value="1"{% if filters.ssh %} checked="checked"{% endif %}><span class="checkmark"></span></label>
            <label class="checkbox_container">Andre tjenester<input id="others_checkbox" type="checkbox" name="others_checkbox" value="1"{% if filters.others %} checked="checked"{% endif %}><span class="checkmark"></span></label>

         <p><b>Søkefunksjon</b><br>
            Bruk menyen til høyre for å velge søkefilter.</p>

            <input type="search" name="vuln_search" {% if filters.vuln_search %} value="{{filters.vuln_search}}" {% endif %}>
            <select name="search_type">
                <option value="product"  {% if filters.search_type == 'hostname' %} selected {% endif %} >Product</option>
                <option value="ip" {% if filters.search_type == 'system' %} selected {% endif %} >IP</option>
                <option value="hostname" {% if filters.search_type == 'bs' %} selected {% endif %} >Hostname</option>
                <option value="port" {% if filters.search_type == 'bss' %} selected {% endif %} >Port</option>
                <option value="comment"  {% if filters.search_type == 'cve' %} selected {% endif %} >Comment</option>
            
            </select>
            <br><br>
            <button class="ButtonTableFilters" type="submit">Søk</button>
            </form>



    <form action="update_shodan_entry" method="post">
        {% csrf_token %}
        <button class="ButtonTableFilters" type="submit">Oppdater kommentarer</button>
    </div>

</div>


<hr class="CVE_Table_HR">
<div class="CVE_Table_Search">
    <input type="search" placeholder="Søk..." class="form-control search-input" data-table="exposed-servers"/>
</div>
<div class="CVE_table">
    <table class="table table-striped mt32 exposed-servers">
    <thead>
        <th>ID</th>
        <th>Product</th>
        <th>IP</th>
        <th>Hostnames</th>

        <th>Port</th>
        <th>HTTP Code</th>
        <th>Last scanned</th>
        {% if Vulns %}
            <th>Vulnerabilities</th>
            <th>CVE</th>
        {% endif %}
        <th>Comments</th>
    </thead>

    {% for Entry in ShodanResults%}
        <tr>
            <td>{{Entry.id}}</td>
            <td>{{Entry.scan_data.product}} {{Entry.scan_data.version}}</td>
            {% if Entry.scan_data.http.status == 200 %}
                {% if Entry.scan_data.port == 80 %}
                    <td><a href="http://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
                {% else %}
                    <td><a href="https://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
                {% endif %}
            {% else %}
                <td><a href="http://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
            {% endif %}
            <td>{% for item in Entry.scan_data.hostnames %}
                <a href="https://{{ item }}" target="_blank">{{ item }} </a>
            {% endfor %}</td>
            {% if Entry.kartoteket_check %}
                <td style="display:none">kartoteket_data</td>
            {% else %}
                <td style="display:none">unmapped</td>
            {% endif %}

            <!--
            <td>{% for item in Entry.kartoteket_data %}
                    {% for key, value in item.items %}
                        <b>{{ key }}</b>: {{ value }}<br>
                    {% endfor %}
             {% endfor %}</td>  
            -->
            <td>{{Entry.scan_data.port}}</td>
            {% if Entry.scan_data.http.status == 200 %}
                <td style="color:green">{{Entry.scan_data.http.status}}</td>
            {% elif Entry.scan_data.http.status > 200 and Entry.scan_data.http.status < 400 %}
                <td style="color:blue">{{Entry.scan_data.http.status}}</td>
            {% elif Entry.scan_data.http.status > 400 %}
                <td style="color:red">{{Entry.scan_data.http.status}}</td>
            {% else %}
                <td>{{Entry.scan_data.http.status}}</td>
            {% endif %}

            <td>{{Entry.scan_data.timestamp}}</td>
            <!-- <td>
            {% for key,value in Entry.scan_data.vulns.items %}
                {% if value.cvss >= 9 %}
                    <div class="CVSS_Critical">
                        <a style="text-decoration: none;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% elif value.cvss >= 7 %}
                    <div class="CVSS_High">
                        <a style="text-decoration: none; text-decoration-color: #f74d40;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% endif %}

            {% endfor %}
            </td> -->
            {% if Vulns %}
            <td>{% for item in Entry.vulnerabilities %}
                    {% if item.severity == 5 %}
                        <div title="{{item.host}}"><div class="CVSS_High"><b>{{ item.vulnerability }}</b><br><br></div> </div>
                    {% elif item.severity == 4 %}
                         <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ item.vulnerability }}</b><br><br></div> </div>
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}

             {% if Vulns %}
            <td style="white-space:nowrap;">{% for item in Entry.vulnerabilities %}
                    {% if item.cve %}
                        {% if item.severity == 5 %}
                            {% for x in item.cve %}
                                <div title="{{item.host}}"><div class="CVSS_High"><b>{{ x }}</b><br></div> </div>
                            {% endfor %}
                            
                        {% elif item.severity == 4 %}
                            {% for x in item.cve %}
                             <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ x }}</b><br></div> </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}
     

     

            <td><textarea rows="2" name="comment" class="autoresize-textarea">{{Entry.comments}}</textarea></td>

            <td style="display:none"><input type="text" name="entry_id" value="{{Entry.id}}"></td>
            
        </tr>
    {% endfor %}
</form>
</table>

</div>
</div>
{% endif %}
{% endblock %}
