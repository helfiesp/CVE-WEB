{% extends "base.html" %}
{% block title %}Shodan{% endblock %}
{% block content %}
{% load custom_tags %}

<header>

<script>
    (function(document) {
    'use strict';

    var TableFilter = (function(myArray) {
        var search_input;

        function _onInputSearch(e) {
            search_input = e.target;
            var tables = document.getElementsByClassName(search_input.getAttribute('data-table'));
            myArray.forEach.call(tables, function(table) {
                myArray.forEach.call(table.tBodies, function(tbody) {
                    myArray.forEach.call(tbody.rows, function(row) {
                        var text_content = row.textContent.toLowerCase();
                        var search_val = search_input.value.toLowerCase();
                        row.style.display = text_content.indexOf(search_val) > -1 ? '' : 'none';
                    });
                });
            });
        }

        return {
            init: function() {
                var inputs = document.getElementsByClassName('search-input');
                myArray.forEach.call(inputs, function(input) {
                    input.oninput = _onInputSearch;
                });
            }
        };
    })(Array.prototype);

    document.addEventListener('readystatechange', function() {
        if (document.readyState === 'complete') {
            TableFilter.init();
        }
    });

})(document);

</script>
</header>
{% if user|has_group:'CSIRT' %}
<div class="CVE_Table_Header">
    <h2>Angrepsflate</h2>
    {% if ShodanResult %}
    <h3>Info om søket</h3>
    <p> <b>Scan time: </b>{{ ShodanScans.ScanTime }}<br>
        {% for key,value in Shodan_Stats.items %}
            <b>{{ key }}</b>: {{ value|replace_comma }}<br>
        {% endfor %}
        {% if ShodanScans.IPChanges != "None" %}
            <br><b>Nye IPer: </b>{{ ShodanScans.IPChanges }}
        {% endif %}
        
    </p>
    {% endif %}
<hr class="CVE_Table_HR">

<div class="button-container">
    <form action="shodan_search" method="post">
        {% csrf_token %}
        <div class="TableFilters">
            
            <label class="checkbox_container">Webservere<input id="webserver_checkbox" type="checkbox" name="webserver_checkbox" value="1"{% if filters.webservers %} checked="checked"{% endif %}><span class="checkmark"></span></label>
            <label class="checkbox_container">SSH<input id="ssh_checkbox" type="checkbox" name="ssh_checkbox" value="1"{% if filters.ssh %} checked="checked"{% endif %}><span class="checkmark"></span></label>
            <label class="checkbox_container">Andre tjenester<input id="others_checkbox" type="checkbox" name="others_checkbox" value="1"{% if filters.others %} checked="checked"{% endif %}><span class="checkmark"></span></label>

         <p><b>Søkefunksjon</b><br>
            Bruk menyen til høyre for å velge søkefilter.</p>

            <input type="search" name="search_term" {% if filters.search_term %} value="{{filters.search_term}}" {% endif %}>
            <select name="search_type">
                <option value="product"  {% if filters.search_type == 'product' %} selected {% endif %} >Product</option>
                <option value="ip" {% if filters.search_type == 'ip' %} selected {% endif %} >IP</option>
                <option value="hostname" {% if filters.search_type == 'hostname' %} selected {% endif %} >Hostname</option>
                <option value="port" {% if filters.search_type == 'port' %} selected {% endif %} >Port</option>
                <option value="comment"  {% if filters.search_type == 'comment' %} selected {% endif %} >Comment</option>
            
            </select>
            <br><br>
            <hr>
            <button class="ButtonTableFilters" type="submit">Søk</button>
            </form>


    <form action="update_shodan_entry" method="post">
        {% csrf_token %}
        <input type="hidden" name="filters" value="{{ filters }}">
        {% if ShodanResults %}
        <button class="ButtonTableFilters" type="submit">Oppdater kommentarer</button>
        {% endif %}
    </div>

</div>

<hr class="CVE_Table_HR">
{% if ShodanResults %}
<div class="CVE_Table_Search">
    <input type="search" placeholder="Søk..." class="form-control search-input" data-table="exposed-servers"/>
</div>
<div class="CVE_table">
    <table class="table table-striped mt32 exposed-servers">
    <thead>
        <th>ID</th>
        <th>Product</th>
        <th>IP</th>
        <th>Hostnames</th>

        <th>Port</th>
        <th>HTTP Code</th>
        <th>Shodan scanned</th>
        <th>NMAP scanned</th>
        {% if Vulns %}
            <th>Vulnerabilities</th>
            <th>CVE</th>
        {% endif %}
        <th>Comments</th>
    </thead>

    {% for Entry in ShodanResults%}
        <tr>
            <td>{{Entry.id}}</td>
            <td>{{Entry.scan_data.product}}</td>
            {% if Entry.scan_data.http.status == 200 %}
                {% if Entry.scan_data.port == 80 %}
                    <td><a href="http://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
                {% else %}
                    <td><a href="https://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
                {% endif %}
            {% else %}
                <td><a href="http://{{Entry.scan_data.ip_str}}" target="_blank">{{Entry.scan_data.ip_str}}</a></td>
            {% endif %}
            <td>{% for item in Entry.scan_data.hostnames %}
                <a href="https://{{ item }}" target="_blank">{{ item }} </a>
            {% endfor %}</td>
            {% if Entry.kartoteket_check %}
                <td style="display:none">kartoteket_data</td>
            {% else %}
                <td style="display:none">unmapped</td>
            {% endif %}

            <!--
            <td>{% for item in Entry.kartoteket_data %}
                    {% for key, value in item.items %}
                        <b>{{ key }}</b>: {{ value }}<br>
                    {% endfor %}
             {% endfor %}</td>  
            -->
            <td>{{Entry.scan_data.port}}</td>
            {% if Entry.scan_data.http.status == 200 %}
                <td style="color:green">{{Entry.scan_data.http.status}}</td>
            {% elif Entry.scan_data.http.status > 200 and Entry.scan_data.http.status < 400 %}
                <td style="color:blue">{{Entry.scan_data.http.status}}</td>
            {% elif Entry.scan_data.http.status > 400 %}
                <td style="color:red">{{Entry.scan_data.http.status}}</td>
            {% else %}
                <td>{{Entry.scan_data.http.status}}</td>
            {% endif %}

            <td>{{Entry.scan_data.timestamp|filter_timestamp}}</td>
            <td>{{Entry.nmap_time}}</td>
            <!-- <td>
            {% for key,value in Entry.scan_data.vulns.items %}
                {% if value.cvss >= 9 %}
                    <div class="CVSS_Critical">
                        <a style="text-decoration: none;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% elif value.cvss >= 7 %}
                    <div class="CVSS_High">
                        <a style="text-decoration: none; text-decoration-color: #f74d40;" href="https://nvd.nist.gov/vuln/detail/{{ key }}">{{ key }} CVSS: <b>{{ value.cvss }}</b></a>
                    </div>
                {% endif %}

            {% endfor %}
            </td> -->
            {% if Vulns %}
            <td>{% for item in Entry.vulnerabilities %}
                    {% if item.severity == 5 %}
                        <div title="{{item.host}}"><div class="CVSS_High"><b>{{ item.vulnerability }}</b><br><br></div> </div>
                    {% elif item.severity == 4 %}
                         <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ item.vulnerability }}</b><br><br></div> </div>
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}

             {% if Vulns %}
            <td style="white-space:nowrap;">{% for item in Entry.vulnerabilities %}
                    {% if item.cve %}
                        {% if item.severity == 5 %}
                            {% for x in item.cve %}
                                <div title="{{item.host}}"><div class="CVSS_High"><b>{{ x }}</b><br></div> </div>
                            {% endfor %}
                            
                        {% elif item.severity == 4 %}
                            {% for x in item.cve %}
                             <div title="{{item.host}}"><div class="CVSS_Medium"><b>{{ x }}</b><br></div> </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
               </td>
            {% endif %}
     

     

            <td><textarea rows="2" name="comment" class="autoresize-textarea">{{Entry.entry_comments}}</textarea></td>

            <td style="display:none"><input type="text" name="entry_id" value="{{Entry.id}}"></td>
            
        </tr>
    {% endfor %}
</form>
</table>

</div>
</div>
{% endif %}
{% endif %}
{% endblock %}
