{% extends "base.html" %}
{% block title %}Qualys{% endblock %}
{% block content %}
{% load custom_tags %}
<header>
<script>
    function ExportToExcel(type, fn, dl) {
    // Fixing the ID selection here:
    var elt = document.getElementById('tbl_exporttable_to_xls change_rowlimit'); 
    var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
    return dl ?
        XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }):
        XLSX.writeFile(wb, fn || ('qualys_vulnerabilities.' + (type || 'xlsx')));
}
function changeRowLimit(value) {
    var rows = document.getElementById("change_rowlimit").rows;
    var rowCount = rows.length - 1; // Subtract 1 for the table header row

    if (value === "all") {
        for (var i = 0; i < rowCount; i++) {
            rows[i + 1].style.display = ""; // Add 1 to the index to skip the table header row
        }
    } else {
        var limit = parseInt(value);

        for (var i = 0; i < rowCount; i++) {
            if (i < limit) {
                rows[i + 1].style.display = ""; // Add 1 to the index to skip the table header row
            } else {
                rows[i + 1].style.display = "none"; // Add 1 to the index to skip the table header row
            }
        }
    }
}
window.addEventListener('DOMContentLoaded', function () {
    try {
        var selectBox = document.getElementById("row-select");
        if (!selectBox) throw new Error("Element with ID 'row-select' not found.");

        selectBox.value = "10"; // Set default select box value to 11
        changeRowLimit(selectBox.value); // Apply the row limit change based on select box value
    } catch (error) {
        console.error("An error occurred:", error.message);
    }
});
(function(document) {
    'use strict';

    var TableFilter = (function(myArray) {
        var search_input;

        function _onInputSearch(e) {
            search_input = e.target;
            var tables = document.getElementsByClassName(search_input.getAttribute('data-table'));
            myArray.forEach.call(tables, function(table) {
                myArray.forEach.call(table.tBodies, function(tbody) {
                    myArray.forEach.call(tbody.rows, function(row) {
                        var text_content = row.textContent.toLowerCase();
                        var search_val = search_input.value.toLowerCase();
                        row.style.display = text_content.indexOf(search_val) > -1 ? '' : 'none';
                    });
                });
            });
        }

        return {
            init: function() {
                var inputs = document.getElementsByClassName('search-input');
                myArray.forEach.call(inputs, function(input) {
                    input.oninput = _onInputSearch;
                });
            }
        };
    })(Array.prototype);

    document.addEventListener('readystatechange', function() {
        if (document.readyState === 'complete') {
            TableFilter.init();
        }
    });

})(document);

</script>
    
</header>


<div class="CVE_Table_Header">
    <form action="/qualys_search" method="post">
    {% csrf_token %}
    <h1>Sårbarhetsoversikten</h1>

    {% if user|has_group:'CSIRT' %}

            <p><b>Velg datagrunnlag: </b>
            <select name="selected_service">
                <option value="All data" {% if not filters.selected_service or filters.selected_service == "All data" %} selected {% endif %}>All data</option>
                {% for service in business_service %}
                    <option value="{{ service }}" {% if filters.selected_service == service %} selected {% endif %}>{{ service }}</option>
                {% endfor %}
            </select>
        {% else %}
            <b>Datagrunnlag</b>: {{ filters.dataset|join:", " }}<br>
            {% if filters.selected_service == "OK-ITAS" or "OK-ITAS" in filters.dataset %}
            <b>Velg sårbarheter for team: </b>
                <td>
                    <select name="team_picker" class="team-input">
                        <option value="Unassigned" {% if not filters.selected_team or filters.selected_team == "Unassigned" %}selected{% endif %}>Unassigned</option>
                        <option value="Team Arkitektur" {% if filters.selected_team == "Team Arkitektur" %}selected{% endif %}>Team Arkitektur</option>
                        <option value="Team Arkiv" {% if filters.selected_team == "Team Arkiv" %}selected{% endif %}>Team Arkiv</option>
                        <option value="Team Katalog" {% if filters.selected_team == "Team Katalog" %}selected{% endif %}>Team Katalog</option>
                        <option value="Team Kjøremiljø" {% if filters.selected_team == "Team Kjøremiljø" %}selected{% endif %}>Team Kjøremiljø</option>
                        <option value="Team M365" {% if filters.selected_team == "Team M365" %}selected{% endif %}>Team M365</option>
                        <option value="Team Modernisering" {% if filters.selected_team == "Team Modernisering" %}selected{% endif %}>Team Modernisering</option>
                        <option value="Team RPA" {% if filters.selected_team == "Team RPA" %}selected{% endif %}>Team RPA</option>
                        <option value="Team Økonomi" {% if filters.selected_team == "Team Økonomi" %}selected{% endif %}>Team Økonomi</option>
                        <option value="Origo" {% if filters.selected_team == "Origo" %}selected{% endif %}>Origo</option>
                    </select>
                </td>

            {% endif %}

        {% endif %}
    </p><p>
        <b>Dato: </b>: {{ filters.last_entry }}<br><br>
        Velg ett eller flere filter for å vise resultater.<br>
        Internett eksponert er alle servere som har blitt funnet via Kartoteket og Shodan.<br>
        Ved å velge kritiske sårbarheter kommer bare sårbarheter som Qualys har merket som severity 5 opp.<br>
        Ved å velge alle så vises alle resultatene fra Qualys (mange tusen linjer).
    </p>
    {% if message %}
    <h2>{{ message }}</h2> 
    {% endif %}
    {% if QualysStats %}
    <h2>Qualys Data</h2>
     {% for key,value in QualysStats.items %}
            <b>{{ key }}</b>: {{ value }}<br>
    {% endfor %}
    {% endif %}
</div>

<hr class="CVE_Table_HR">
<div class="TableFilters">
    <p><b>Filter</b></p>
    <label class="checkbox_container">Oversikt<input type="checkbox" name="overview_checkbox" value="1"{% if filters.overview %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Internett eksponert<input type="checkbox" name="internetex_checkbox" value="1"{% if filters.internet_exposed %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Kritiske sårbarheter<input type="checkbox" name="critical_vulns_checkbox" value="1"{% if filters.critical_vulns %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">CISA known exploited<input type="checkbox" name="knownex_checkbox" value="1"{% if filters.known_exploited %} checked="checked"{% endif %}><span class="checkmark"></span></label>

    <p><b>Ekstra kolonner</b></p>
    <label class="checkbox_container">Filsti<input type="checkbox" name="filepath_checkbox" value="1"{% if filters.filepath %} checked="checked"{% endif %}><span class="checkmark"></span></label>

    <label class="checkbox_container">Systeminfo<input type="checkbox" name="systeminfo_checkbox" value="1"{% if filters.systeminfo %} checked="checked"{% endif %}><span class="checkmark"></span></label>

    <label class="checkbox_container">Business service<input type="checkbox" name="business_service_checkbox" value="1"{% if filters.business_service %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Filtrer ut kernel<input type="checkbox" name="filter_kernel_checkbox" value="1"{% if filters.filter_kernel %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Filtrer ut falsk positive<input type="checkbox" name="filter_false_checkbox" value="1"{% if filters.filter_false %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Filtrer ut 2S ansvarlig<input type="checkbox" name="filter_2s_responsible_checkbox" value="1"{% if filters.filter_2s_responsible %} checked="checked"{% endif %}><span class="checkmark"></span></label>

    <hr class="CVE_Table_HR">
    <p><b>Søkefunksjon</b><br>
    Bruk menyen til høyre for å velge søkefilter.</p>

    <input type="search" name="vuln_search" {% if filters.vuln_search %} value="{{filters.vuln_search}}" {% endif %}>
    <select name="search_type">
        <option value="hostname"  {% if filters.search_type == 'hostname' %} selected {% endif %} >Hostname</option>
        <option value="system" {% if filters.search_type == 'system' %} selected {% endif %} >System</option>
        <option value="bs" {% if filters.search_type == 'bs' %} selected {% endif %} >Business service</option>
        <option value="bss" {% if filters.search_type == 'bss' %} selected {% endif %} >Business sub-service</option>
        <option value="cve"  {% if filters.search_type == 'cve' %} selected {% endif %} >CVE</option>
        <option value="qualys_id"  {% if filters.search_type == 'qualys_id' %} selected {% endif %} >Qualys ID</option>
        <option value="vulnerability_name"  {% if filters.search_type == 'vulnerability_name' %} selected {% endif %}>Sårbarhet</option>
        <option value="filepath"  {% if filters.search_type == 'filepath' %} selected {% endif %}>Filsti</option>
        <option value="internal_ip"  {% if filters.search_type == 'internal_ip' %} selected {% endif %}>Intern IP</option>
        <option value="external_ip"  {% if filters.search_type == 'external_ip' %} selected {% endif %}>Ekstern IP</option>
    </select>
    <br><br>
    <button class="ButtonTableFilters" type="submit">Søk</button>
    </form>

<div>

{% if overview_table %}
<hr class="CVE_Table_HR">
<div class="CVE_table">
<br>
<h3>Oversikt over sårbarhetene</h3>
Her vises antall av hver sårbarhet i resultatet.<br><br>
<b>Totalt antall sårbarheter:</b> {{ overview_table.total_count }}<br>
<b>Antall unike assets:</b>{{ overview_table.unique_hosts }}</p>


{% if user|has_group:'CSIRT' %}
    {% if not filters.selected_service or filters.selected_service == "All data" %}
     <table id="business_services_table" class="table table-striped mt32 exposed-servers sortable">
        <thead>
            <th class="business_service">Business Service</th>
            <th class="total_count">Total Count</th>
            <th class="severity_5">Critical</th>
            <th class="severity_4">High</th>
            <th class="severity_3">Medium</th>
            <th class="severity_2">Low</th>
            <th class="severity_1">Informational</th>
        </thead>
        <tbody>
            {% for service, data in overview_table.business_service_data.items %}
            <tr>
                <td class="business_service">{{ service }}</td>
                <td class="total_count">{{ data.total }}</td>
                <td class="severity_5">{{ data.severity_counts.5 }}</td>
                <td class="severity_4">{{ data.severity_counts.4 }}</td>
                <td class="severity_3">{{ data.severity_counts.3 }}</td>
                <td class="severity_2">{{ data.severity_counts.2 }}</td>
                <td class="severity_1">{{ data.severity_counts.1 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% endif %}
{% endif %}
<table id="change_rowlimit" class="table table-striped mt32 exposed-servers sortable">
            <thead>
                <th class="severity">Severity</th>
                <th class="vuln_title">Vulnerable assets</th>
            </thead>
            <tbody>
                {% if overview_table.EOL %}
                    <tr>
                        <td class="CVSS_Score_Numeric_DarkRed severity">End of life</td>
                        <td class="AffectedUsersCount">{{overview_table.EOL}}</td>
                    </tr>
                {% endif %}
                {% if overview_table.5 %}
                    <tr>
                        <td class="CVSS_Score_Numeric_DarkRed severity">Critical</td>
                        <td class="AffectedUsersCount">{{overview_table.5}}</td>
                    </tr>
                {% endif %}

           
                {% if overview_table.4 %}
                    <tr>
                        <td class="CVSS_Score_Numeric_Red severity">High</td>
                        <td class="AffectedUsersCount">{{overview_table.4}}</td>
                    </tr>
                {% endif %}
           
                {% if overview_table.3 %}
                    <tr>
                        <td class="CVSS_Score_Numeric_Yellow severity">Medium</td>
                        <td class="AffectedUsersCount">{{overview_table.3}}</td>
                    </tr>
                {% endif %}
            
                {% if overview_table.2 %}
                    <tr>
                        <td class="CVSS_Score_Numeric_Green severity">Low</td>
                        <td class="AffectedUsersCount">{{overview_table.2}}</td>
                    </tr>
                {% endif %}
           
                {% if overview_table.1 %}
                    <tr>
                        <td class="CVSS_Score_Numeric_Gray severity">Informational</td>
                        <td class="AffectedUsersCount">{{overview_table.1}}</td>
                    </tr>
                {% endif %}
        </tbody>
    </table>
<br>

    <div>
        <label for="row-select">Antall kolonner:</label>
        <select id="row-select" onchange="changeRowLimit(this.value)">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="all">All</option>
        </select>
    </div>
    <form id="comment-form" method="POST" action="{% url 'update_qualys_comments' %}">
        {% csrf_token %}
        <input type="hidden" name="filters" value="{{ filters }}">
        <table id="change_rowlimit" class="table table-striped mt32 exposed-servers sortable">
            <thead>
                <th class="severity">Severity</th>
                <th class="vuln_title">Title</th>
                <th class="cve">CVE</th>
                <th class="affected_hosts">Affected hosts</th>

            </thead>
            <tbody>
            {% for Entry in overview_table.data %}
            <tr>
                {% if Entry.severity == 5 %}
                    <td class="CVSS_Score_Numeric_DarkRed severity">{{Entry.severity}}</td>
                {% elif Entry.severity == 4 %}
                    <td class="CVSS_Score_Numeric_Red severity">{{Entry.severity}}</td>
                {% elif Entry.severity == 3 %}
                    <td class="CVSS_Score_Numeric_Yellow severity">{{Entry.severity}}</td>
                {% elif Entry.severity == 2 %}
                    <td class="CVSS_Score_Numeric_Green severity">{{Entry.severity}}</td>
                {% else %}
                    <td class="CVSS_Score_Numeric_Grey severity">{{Entry.severity}}</td>
                {% endif %}
                <td class="vuln_title">
                    <a href="{% url 'qualys_search_vulnerability_by_id' vulnerability=Entry.qualys_id %}?filters={{ filters|urlencode }}">
                        {{Entry.title}}
                    </a>
                </td>


<td class="cve">
    {% for cve in Entry.cve|limit_commas|split:"," %}
        {% if not '…' in cve and cve|trim_spaces != 'N/A' and cve|trim_spaces != 'and more...' %}
            <a href="https://nvd.nist.gov/vuln/detail/{{ cve|trim_spaces }}" target="_blank">{{ cve|trim_spaces }}</a>{% if not forloop.last %}, {% endif %}
        {% else %}
            {{ cve|trim_spaces }}{% if not forloop.last and cve|trim_spaces != 'and more...' %}, {% endif %}
        {% endif %}
    {% endfor %}
</td>
<td class="cve" style="display:none;">{{Entry.cve}}</td>

<td class="AffectedUsersCount">
    <a href="{% url 'qualys_search_vulnerability_by_id' vulnerability=Entry.qualys_id %}?filters={{ filters|urlencode }}">{{Entry.count}}</a>
</td>


                <td style="display:none;" class="hostnames">
                    {% for hostname in Entry.hostnames %}
                        <input type="hidden" name="hostnames" value="{{Entry.title}}-|-{{ hostname }}">
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </form>
</div>
{% endif %}
<br>


{% if overview_table.show_table != None and filters.selected_service != 'All data' %}

<hr class="CVE_Table_HR">
<div class="CVE_Table_Search">
    <input type="search" placeholder="Søk i kolonnen..." class="form-control search-input" data-table="exposed-servers"/>

    <button onclick="ExportToExcel('xlsx')">Eksporter data</button>
        <form action="/update_qualys_comments" method="post">
        {% csrf_token %}
        <button class="ButtonTableFilters" type="submit">Update comments</button> 
</div>

<div class="CVE_table">


    <input type="hidden" name="filters" value="{{ filters }}">
    <table id="tbl_exporttable_to_xls change_rowlimit" class="table table-striped mt32 exposed-servers sortable">
    <thead>
        <th class="qualys_id">ID</th>
        <th class="severity">Severity</th>
        <th class="status">Status</th>
        <th class="hostname">Hostname</th>
        <th class="internal_ip">IP</th>
        <th class="os">OS</th>
        <th class="vuln_title">Title</th>
        <th class="first_detected">First detected</th>
        <th class="last_detected">Last Detected</th>
        <th class="last_fixed">Last Fixed</th>
        {% if filters.business_service %}
            <th class="bs">Business service</th>
            <th class="bss">Business sub-service</th>
        {% endif %}
        {% if filters.systeminfo %}
            <th class="system">System</th>
            <th class="systemcompany">Systemforvalter</th>
            <th class="systemmanager">Systemforvaltere</th>
        {% endif %}

        {% if not filters.all_entries %}
            <th class="internet_exposed">Internet Exposed</th>
        {% endif %}
        <th class="cve">CVE</th>
        {% if filters.filepath %}
            <th class="filepath">Filepath</th>
        {% endif %}

        {% if filters.selected_service == "OK-ITAS" or "OK-ITAS" in filters.dataset %}
            <th class="comments">Team</th>
        {% endif %}
    
        <th class="comments">Comments</th>
        <th class="false_positive">False positive</th>
    </thead>
    <tbody>
    {% for Entry in QualysResults %}
        <tr>
            <td class="qualys_id">{{Entry.id}}</td>
            {% if Entry.severity == 5 %}
                <td class="CVSS_Score_Numeric_DarkRed severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 4 %}
                <td class="CVSS_Score_Numeric_Red severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 3 %}
                <td class="CVSS_Score_Numeric_Yellow severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 2 %}
                <td class="CVSS_Score_Numeric_Green severity">{{Entry.severity}}</td>
            {% else %}
                <td class="CVSS_Score_Numeric_Grey severity">{{Entry.severity}}</td>
            {% endif %}
            <td class="status">{{Entry.status}}</td>
            <td class="hostname">
                <a href="{% url 'qualys_search_vulnerability_by_hostname' hostname=Entry.hostname %}?filters={{ filters|urlencode }}">
                    {{Entry.hostname}}
                </a>
            </td>
            <td class="internal_ip">{{Entry.ip}}</td>
            <td class="os">

                <a href="https://kartoteket.oslo.kommune.no/cmdb/servere/?device_search_term={{ Entry.os }}" target="_blank">
                    {{Entry.os}}
                </a>
            </td>

            <td class="vuln_title">
                <a href="{% url 'qualys_search_vulnerability_by_id' vulnerability=Entry.qualys_id %}?filters={{ filters|urlencode }}">
                    {{Entry.title}}
                </a>
            </td>

            <td class="first_detected">{{Entry.first_detected}}</td>
            <td class="last_detected">{{Entry.last_detected}}</td>
            <td class="last_fixed">{{Entry.last_fixed}}</td>
            {% if filters.business_service %}
                <td class="bs">{{Entry.bs}}</td>
                <td class="bss">{{Entry.bss}}</td>
            {% endif %}
            {% if filters.systeminfo %}
                <td class="system">{{Entry.system}}</td>
                <td class="systemcompany">{{Entry.systemcompany}}</td>

                <td class="systemmanager">{{Entry.systemmanager}}
                </td>
            {% endif %}
            {% if not filters.all_entries %}
                <td class="internet_exposed">{{Entry.internet_exposed}}</td>
            {% endif %}


        <td class="cve">
            {% for cve in Entry.cve|limit_commas|split:"," %}
                {% if not '…' in cve and cve|trim_spaces != 'N/A' and cve|trim_spaces != 'and more...' %}
                    <a href="https://nvd.nist.gov/vuln/detail/{{ cve|trim_spaces }}" target="_blank">{{ cve|trim_spaces }}</a>{% if not forloop.last %}, {% endif %}
                {% else %}
                    {{ cve|trim_spaces }}{% if not forloop.last and cve|trim_spaces != 'and more...' %}, {% endif %}
                {% endif %}
            {% endfor %}
        </td>
        <td class="cve" style="display:none;">{{Entry.cve}}</td>

            {% if filters.filepath %}
                <td class="filepath">{{Entry.filepath}}</td>
            {% endif %}


                {% if filters.selected_service == "OK-ITAS" or "OK-ITAS" in filters.dataset %}
                    <td>
                        <select name="team_{{Entry.id}}" class="team-input">
                            <option value="Unassigned" {% if not Entry.team or Entry.team == "Unassigned" %}selected{% endif %}>Unassigned</option>
                            <option value="Team Arkitektur" {% if Entry.team == "Team Arkitektur" %}selected{% endif %}>Team Arkitektur</option>
                            <option value="Team Arkiv" {% if Entry.team == "Team Arkiv" %}selected{% endif %}>Team Arkiv</option>
                            <option value="Team Katalog" {% if Entry.team == "Team Katalog" %}selected{% endif %}>Team Katalog</option>
                            <option value="Team Kjøremiljø" {% if Entry.team == "Team Kjøremiljø" %}selected{% endif %}>Team Kjøremiljø</option>
                            <option value="Team M365" {% if Entry.team == "Team M365" %}selected{% endif %}>Team M365</option>
                            <option value="Team Modernisering" {% if Entry.team == "Team Modernisering" %}selected{% endif %}>Team Modernisering</option>
                            <option value="Team RPA" {% if Entry.team == "Team RPA" %}selected{% endif %}>Team RPA</option>
                            <option value="Team Økonomi" {% if Entry.team == "Team Økonomi" %}selected{% endif %}>Team Økonomi</option>
                            <option value="Origo" {% if Entry.team == "Origo" %}selected{% endif %}>Origo</option>
                        </select>
                    </td>

                {% endif %}
            <td><textarea rows="2" name="comment_{{Entry.id}}">{{Entry.comments}}</textarea></td>
            <td>
                <label style="margin-top:-20px;" class="checkbox_container_false_positive">
                    <input type="checkbox" name="false_positive_checkbox-{{Entry.id}}" value="1"{% if Entry.false_positive %} checked="checked"{% endif %}>
                    <span class="checkmark_false_positive"></span>
                </label>
            </td>


        </tr>
    {% endfor %}
    </tbody>
</form>
</table>
</div>
{% endif %}
</div>
{% endblock %}

