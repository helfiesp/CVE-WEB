{% load static %}
<html>
<header>
<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
<title>Qualys</title>
<link rel="stylesheet" href="{% static 'css/main_css.css' %}">

<script>
    function exportTableToExcel(tableID, filename = ''){
    var downloadLink;
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById(tableID);
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    
    // Specify file name
    filename = filename?filename+'.xls':'excel_data.xls';
    
    // Create download link element
    downloadLink = document.createElement("a");
    
    document.body.appendChild(downloadLink);
    
    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['\ufeff', tableHTML], {
            type: dataType
        });
        navigator.msSaveOrOpenBlob( blob, filename);
    }else{
        // Create a link to the file
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
    
        // Setting the file name
        downloadLink.download = filename;
        
        //triggering the function
        downloadLink.click();
    }
    }
    (function(document) {
        'use strict';

        var TableFilter = (function(myArray) {
            var search_input;

            function _onInputSearch(e) {
                search_input = e.target;
                var tables = document.getElementsByClassName(search_input.getAttribute('data-table'));
                myArray.forEach.call(tables, function(table) {
                    myArray.forEach.call(table.tBodies, function(tbody) {
                        myArray.forEach.call(tbody.rows, function(row) {
                            var text_content = row.textContent.toLowerCase();
                            var search_val = search_input.value.toLowerCase();
                            row.style.display = text_content.indexOf(search_val) > -1 ? '' : 'none';
                        });
                    });
                });
            }

            return {
                init: function() {
                    var inputs = document.getElementsByClassName('search-input');
                    myArray.forEach.call(inputs, function(input) {
                        input.oninput = _onInputSearch;
                    });
                }
            };
        })(Array.prototype);

        document.addEventListener('readystatechange', function() {
            if (document.readyState === 'complete') {
                TableFilter.init();
            }
        });

    })(document);
</script>
</header>

<div class="Top_Nav">
    <div class="dropdown">
        <button class="Top_Nav_Button" onclick="location.href='{% url 'index' %}'">CVE</button>
    
    </div>
    <div class="dropdown">
        <button class="Top_Nav_Button" onclick="location.href='{% url 'shodan' %}'">Attack surface</button>
        <div class="dropdown-content">
          <a onclick="location.href='{% url 'shodan' %}'">Shodan</a>
        </div>
    </div>
    <button class="Top_Nav_Button" onclick="location.href='{% url 'qualys' %}'">Qualys</button>

</div>
<div class="CVE_Table_Header">
    <h1>Qualys data</h1>
    <p>Velg ett eller flere filter for å vise resultater.<br>
    Internett eksponert er alle servere som har blitt funnet via Kartoteket og Shodan.<br>
    Ved å velge kritiske sårbarheter kommer bare sårbarheter som Qualys har merket som severity 5 opp.<br>
    Ved å velge alle så vises alle resultatene fra Qualys (mange tusen linjer).
    </p>
    {% if message %}
    <h2>{{ message }}</h2> 
    {% endif %}
    {% if QualysStats %}
    <h2>Qualys Data</h2>
     {% for key,value in QualysStats.items %}
            <b>{{ key }}</b>: {{ value }}<br>
    {% endfor %}
    {% endif %}
</div>

<hr class="CVE_Table_HR">
<div class="TableFilters">
    <form action="qualys_search" method="post">
    {% csrf_token %}
    <label class="checkbox_container">Alle<input type="checkbox" name="all_checkbox" value="1"{% if filters.all_entries %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Internett eksponert<input type="checkbox" name="internetex_checkbox" value="1"{% if filters.internet_exposed %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Kritiske sårbarheter<input type="checkbox" name="critical_vulns_checkbox" value="1"{% if filters.critical_vulns %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Filsti<input type="checkbox" name="filepath_checkbox" value="1"{% if filters.filepath %} checked="checked"{% endif %}><span class="checkmark"></span></label>
    <label class="checkbox_container">Known exploited<input type="checkbox" name="knownex_checkbox" value="1"{% if filters.known_exploited %} checked="checked"{% endif %}><span class="checkmark"></span></label><button class="ButtonTableFilters" type="submit">Søk</button>
    </form>

</div>
{% if QualysResults %}
<hr class="CVE_Table_HR">
<div class="CVE_Table_Search">
    <input type="search" placeholder="Søk i kolonnen..." class="form-control search-input" data-table="exposed-servers"/>
</div>
<div class="CVE_table">
    <table id="tblData" class="table table-striped mt32 exposed-servers">
    <thead>
        <th class="qualys_id">ID</th>
        <th class="severity">Severity</th>
        <th class="hostname">Hostname</th>
        <th class="internal_ip">IP</th>
        <th class="os">OS</th>
        <th class="vuln_title">Title</th>
        <th class="first_detected">First detected</th>
        <th class="last_detected">Last Detected</th>
        <th class="last_fixed">Last Fixed</th>
        {% if not filters.all_entries %}
            <th class="internet_exposed">Internet Exposed</th>
        {% endif %}
        <th class="cve">CVE</th>
        {% if filters.filepath %}
            <th class="filepath">Filepath</th>
        {% endif %}
    </thead>
    <tbody>
    {% for Entry in QualysResults %}
        <tr>
            <td class="qualys_id">{{Entry.id}}</td>
            {% if Entry.severity == 5 %}
                <td class="CVSS_Score_Numeric_DarkRed severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 4 %}
                <td class="CVSS_Score_Numeric_red severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 3 %}
                <td class="CVSS_Score_Numeric_yellow severity">{{Entry.severity}}</td>
            {% elif Entry.severity == 2 %}
                <td class="CVSS_Score_Numeric_Green severity">{{Entry.severity}}</td>
            {% else %}
                <td class="severity">{{Entry.severity}}</td>
            {% endif %}
            <td class="hostname">{{Entry.hostname}}</td>
            <td class="internal_ip">{{Entry.ip}}</td>
            <td class="os">{{Entry.os}}</td>
            <td class="vuln_title">{{Entry.title}}</td>
            <td class="first_detected">{{Entry.first_detected}}</td>
            <td class="last_detected">{{Entry.last_detected}}</td>
            <td class="last_fixed">{{Entry.last_fixed}}</td>
            {% if not filters.all_entries %}
                <td class="internet_exposed">{{Entry.internet_exposed}}</td>
            {% endif %}
            {% if Entry.cve|length > 30 %}
                <td class="cve">{{Entry.cve|truncatechars:30}}</td>
                <td class="cve" style="display:none;">{{Entry.cve}}</td>
            {% else %}
                <td class="cve">{{Entry.cve}}</td>
            {% endif %}
            {% if filters.filepath %}
                <td class="filepath">{{Entry.filepath}}</td>
            {% endif %}
        </tr>
    {% endfor %}
    </tbody>
</table>
<button onclick="exportTableToExcel('tblData')">Export Table Data To Excel File</button>
</div>
{% endif %}
</div>
</html>

